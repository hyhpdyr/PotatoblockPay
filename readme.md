# 土豆方块支付

> [点击此处](mailto:gwc1718781342@163.com)向作者发送邮件。  

## 监听部署

### 数据库

本程序依赖 `MySQL` 数据库运行。请确保数据库已准备妥当，后续 `监听支付` 将需要填入数据库相关信息。  

部署 `MySQL` 完成后，请在准备使用的数据库下执行 `/建表语句.sql` 来初始化数据库。  

### 监听支付

以下内容中的文件全部在 `/Listener/` 目录下。  

下载 `Python3` 并使用 `pip` 下载 `requirements.txt` 中的全部库。  

#### 微信支付 (WeChat)

回调速度尚可的实现，且最为不易封禁。  

本服务必须部署在 `Windows` 操作系统上，且设备架构应当为 `AMD64` 。  

打开 `微信电脑版 3.9.12.51` ，并双击 `微信支付` 聊天窗口使其独立出来，并保持该窗口始终活跃显示。  

> 温馨提示: 此处推荐按下 `微信支付` 窗口右上角的 `📌` 按钮，这样窗口会始终保持置顶。  

进入 `/WeChatPay/` 目录，修改配置文件 `cfg.py` 并启动 `main.py` 。  

> 温馨提示: 更换微信账号或微信支付聊天记录被清理后，应当删除 `/WeChatPay/not_first_use.sig` 文件，否则收款的第一单将会遗漏。  

#### 支付宝 (Alipay)

回调速度最为缓慢的实现，且有概率封号。  

本服务必须部署在 `Windows` 操作系统上，且设备架构应当为 `AMD64` 。  

使用前请先检查 `Edge` 浏览器是否已经安装，且版本号是否为 `138.0.3351.83` 。如有不符，请您自行更换浏览器驱动。  

进入 `/Alipay/` 目录，修改配置文件 `cfg.py` 并启动 `main.py` 。  

程序将会操控浏览器弹出支付宝登陆页面。请您使用手机支付宝手动扫码登陆，并在完成后向程序中输入任意字符。  

支付宝可能会弹出扫码验证，如果遇到，根据程序指引手动扫码解决即可。  

#### 爱发电 (AFDian)

回调速度最快的实现，且最为稳定，但有概率封号，且需要一个月才能提现，且有提现费率（具体取决于爱发电官方）。  

此实现很特殊，内含 `微信支付` 、 `支付宝` 、 `PayPal` 等支付方式（具体取决于爱发电官方）。  

使用前需要先去 [爱发电开发者官网 (https://afdian.com/dashboard/dev)](https://afdian.com/dashboard/dev) 绑定 `Webhook` 通知地址。  

在爱发电发布一个价格为1元的商品，且需允许叠加下单。仅需创建订单后，引导用户在爱发电下单与你所创建的订单价格相等的该种商品，即可完成回调。  

进入 `/AFDian/` 目录，修改配置文件 `cfg.py` 并启动 `main.py` 。  

> 温馨提示: 此处配置的 `Webhook` 端口与服务器地址必须与在 `爱发电` 配置的一致。  

#### Trc20-USDT (TrUSDT)

由于加密货币的特殊性，这里不参与评价。  

进入 `/Trc20USDT/` 目录，修改配置文件 `cfg.py` 并启动 `main.py` 。  

### 在服务器上部署

`微信支付` 监听程序依赖GUI运行。如需监听 `微信支付` ，请在停止连接远程主机时启动 `保持GUI加载.bat` ，这样服务器画面会在断开远程连接后继续保持加载。  

`爱发电` 监听程序需要拥有公网端口，没有的可以用内网穿透，这里不做赘述。  

### 特殊说明

> 为了保证部署在不同服务器上的各个程序的时间一致，程序若需获取当前时间，并不使用 `time.time()` ，而是调用 `土豆方块开放API` 获取。该函数名为 `get_time` ，在程序文件顶部显眼位置被定义。您也可以自行替换成其他实现，仅需保证各个程序的时间一致性，否则可能会引发奇怪的问题。  

## 后台调用

### 支付网关

#### 服务端部署

以下内容中的文件全部在 `/API/` 目录下。  

支付网关可以使用 `HTTP` 或 `WebSocket` 调用，理论支持任意语言使用。  

下载 `Python3` 并使用 `pip` 下载 `requirements.txt` 中的全部库。  

修改配置文件 `cfg.py` 并启动 `main.py` 。  

> 为了保证非人民币与人民币汇率的实时性，在使用非人民币支付订单时，调用 `土豆方块开放API` 获取实时汇率。它们的函数名为 `get_*_price` （此处 `*` 是通配符），在程序文件顶部显眼位置被定义。您也可以自行替换成其他实现，仅需保证汇率的实时性。  

#### 客户端调用

以下内容中的文件全部在 `/SDK/` 目录下。  

找到您需要的语言版本的库文件夹，下载依赖并导入即可使用。  

请自行根据源码探索使用方式，通常会给出使用示例。  

> 温馨提示: 可以使用 `"{支付网关基础URL}/pay?method={支付方式英文}&channel={通道ID}&amount={实际金额}&timeout={超时所需秒数}&trade={订单号}&redirect={支付完成后跳转到的URL}"` 让用户来到支付网关前台。前台仅起到显示作用，不参与后端逻辑。  

### 发卡网插件

以下内容中的文件若无特殊说明则全部在 `/Plugins/` 目录下。  

使用前请先部署 `支付网关` ，否则无法使用。

#### 异次元发卡网 (acg-faka)

自动下载: 首先尝试在插件市场搜索插件 `土豆方块支付` 并下载，如果找不到则尝试手动下载插件。  

手动下载: 下载 `/acg-faka/` 目录下的全部文件，在您的发卡网根目录的 `app/Pay/` 中创建文件夹 `Potatoblockpay` 并将源码上传至此。  

配置发卡网 `支付插件` 中的 `土豆方块支付` 插件。  

### 独立调用

以下内容中的文件全部在 `/API/` 目录下。  

不推荐，且只有 `Python3` 可以直接调用底层接口。建议使用支付网关间接调用，避免出现奇奇怪怪的问题。  

下载 `Python3` 并使用 `pip` 下载 `requirements.txt` 中的全部库。  

将 `/API/` 目录作为一整个库导入。使用案例参照 `example.py` 即可。  

> 温馨提示: 单套监听程序只能被一个独立后台程序调用，多个独立后台程序同时调用会引发奇怪的问题。可以通过多个程序调用一个支付网关总控程序来解决。  
备注: 使用同一个 `MySQL数据库` 的多个监听程序即为 `单套监听程序` 。  
